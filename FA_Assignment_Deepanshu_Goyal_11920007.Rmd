---
title: "Forcasting Analysis - Assignment"
author: "Deepanshu Goyal"
date: "November 21, 2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
rm(list=ls())
library(xlsx)
library(timeSeries)
library(forecast)
library(tseries)
library(ggplot2)
```

```{r Souvenier}
sales = read.xlsx("SouvenirSales.xlsx",sheetIndex = "SouvenirSales")
print(dim(sales))

sales_ts = ts(data = sales$Sales,start = c(1995,1),frequency = 12)
sales_ts
```
```{r split the data}
train = window(sales_ts,end=c(2000,12),frequency=12)
test = window(sales_ts,start=c(2001,1),frequency=12)
print(train)
print(test)
```

# 1.a Plot the time series of the original data. Which time series components appear from the plot
# - Sales data has 84 level
# - Sales data has increasing trend (Curvilinear) over a long period of time
# - Sales data has monthly Seasonality (at the end of each year)
# - Sales data has negligible cyclicality
# - Sales data has noise

```{r question 1.a, echo=FALSE}
autoplot(sales_ts)
```
# 1.b Fit a linear trend model with additive seasonality (Model A) and exponential trend model with multiplicative seasonality (Model B). Consider January as the reference group for each model. Produce the regression coefficients and the validation set errors. Remember to fit only the training period

```{r question 1.b }
# Linear model with additive seasonality
sales.lm.a = tslm(train ~ trend + season)
#Coefficients of linerar model
print(sales.lm.a)
#Forecast for next 12 months
sales_predict_a = forecast(sales.lm.a, h = 12)
#Calculate validation residuals & RMSE
residual_a = test - sales_predict_a$mean
print(accuracy(sales_predict_a$mean,test))

# Exponential trend model with multiplicative seasonality
sales.expo.m = tslm(train ~ trend + season, lambda = 0)
#Coefficients of exponential model
print(sales.expo.m)
#Forecast for next 12 months
sales_predict_m = forecast(sales.expo.m, h = 12, level=0)
#Calculate validation residuals & RMSE
residual_m = test - sales_predict_m$mean
print(accuracy(sales_predict_m$mean,test))

```
# 1.c Which model is the best model considering RMSE as the metric? Could you have understood this from the line chart? Explain. Produce the plot showing the forecasts from both models along with actual data. In a separate plot, present the residuals from both models (consider only the validation set residuals).

```{r question 1.c}
y_range = range(sales_ts)

# Plot for linear trend & additive seasonality
plot(c(1995,2002),y_range,type="n",xlab="Year",ylab="Sales",main="Regression Model with linear trend and additive seasonality")
lines(sales_ts, bty="l", main="Original series")
lines(sales.lm.a$fitted.values,col='blue')
lines(sales_predict_a$mean,col='red')
legend(1995,100000,c('Actual Data','Linear Trend & Additive Season','Forecast'),lty=c(1,1,2),col=c('black','blue','red'))

#residual plot of training set
autoplot(sales.lm.a$residuals,main = "Residual Plot of Linear Model Training Set")

#Plot validation residual for linear trend & additive seasonality
autoplot(residual_a,main = "Validation Set Residual - Linear Trend & Additive Seasonality")

# Plot for exponential trend & multiplicative seasonality

plot(c(1995,2002),y_range,type="n",xlab="Year",ylab="Sales",main="Regression Model with exponential trend and multiplicative seasonality")
lines(sales_ts, bty="l", main="Original series")
lines(sales.expo.m$fitted.values,col='blue')
lines(sales_predict_m$mean,col='red')

legend(1995,100000,c('Actual Data','Exponential Trend & Multiplicative Season','Forecast'),lty=c(1,1,2),col=c('black','blue','red'))

#residual plot of training set
autoplot(sales.expo.m$residuals,main = "Residual Plot of Exponential Model Training Set")


#Plot validation residual for exponential trend & multiplicative seasonality
autoplot(residual_m,main = "Validation Set Residual - Exponential Trend & Multiplicative Seasonality")

```
# 1.d Examine the additive model. Which month has the highest average sales during the year. What does the estimated trend coefficient in the model A mean?
# - December has the highest average sales during the year
# - Trend coffient means: 1 unit increase in the trend will increase the sales by 245.3642 units

```{r question 1.d}
sales.lm.a$coefficients
```
# 1.e Examine the multiplicative model. What does the coefficient of October mean? What does the estimated trend coefficient in the model B mean?
# - Coefficient of October means: Sales in October is 72.94% higher than Sales in January
# - 1 unit increase in trend will increase the sales by 2.1%
```{r question 1.e}
sales.expo.m$coefficients
```

# 1.f Use the best model type from part (c) to forecast the sales in January 2002. Think carefully which data to use for model fitting in this case.
```{r question 1.f}
sales.expo.m_total = tslm(sales_ts ~ trend + season, lambda = 0)
prediction = forecast(sales.expo.m_total, h=1)
prediction
```

# 1.g Plot the ACF and PACF plot until lag 20 of the residuals obtained from training set of the best model chosen. Comment on these plots and think what AR(p) model could be a good choice?
# - ACF plot is decreasing rapidly, hence we can say that time series in stationary
# - For AR model, we will look at PACF plot. First two lagged values are significant hance we will take p = 2 for AR model

```{r question 1.g}
#plot ACF & PACF plots
Acf(sales.expo.m$residuals,lag.max = 20,main="ACF Plot")
Pacf(sales.expo.m$residuals,lag.max = 20,main="PACF Plot")

#ADF test on training forecast residuals
adf.test(sales.expo.m$residuals)


```

# 1.h Fit an AR(p) model as you think appropriate from part (g) to the training set residuals and produce the regression coefficients. Was your intuition at part (g) correct?

```{r question 1.h}
ar_model = arima(sales.expo.m$residuals,c(2,0,0))
Pacf(ar_model$residuals)
summary(ar_model)

ar_prediction = forecast(ar_model,h=12)
final_prediction = sales_predict_m$mean +ar_prediction$mean
print(accuracy(final_prediction,test))
print(accuracy(sales_predict_m,test))
```

# 1.i Now, using the best regression model and AR(p) model, forecast the sales in January 2002. Think carefully which data to use for model fitting in this case.
```{r question 1.i}

ar_total = arima(sales.expo.m_total$residuals, c(2,0,0))
prediction2 = forecast(ar_total,h=1)

final_prediction = prediction$mean +prediction2$mean
final_prediction
autoplot(ar_model$residuals)
```

